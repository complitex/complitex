<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.osznconnection.file.service.privilege.PrivilegeFileGroupBean">
    <resultMap id="privilegeFileGroupResultMap" type="org.complitex.osznconnection.file.entity.privilege.PrivilegeFileGroup">
        <id column="gid" property="id"/>
        
        <result column="loaded_record_count" property="loadedRecordCount"/>
        <result column="binded_record_count" property="bindedRecordCount"/>
        <result column="filled_record_count" property="filledRecordCount"/>

        <association property="firstRequestFile" javaType="org.complitex.osznconnection.file.entity.RequestFile">
            <id column="f_id" property="id"/>
            <result column="f_groupId" property="groupId"/>
            <result column="f_loaded" property="loaded"/>
            <result column="f_name" property="name"/>
            <result column="f_directory" property="directory"/>
            <result column="f_organization_id" property="organizationId"/>
            <result column="f_user_organization_id" property="userOrganizationId"/>
            <result column="f_begin_date" property="beginDate"/>
            <result column="f_end_date" property="endDate"/>
            <result column="f_dbf_record_count" property="dbfRecordCount"/>
            <result column="f_length" property="length"/>
            <result column="f_check_sum" property="checkSum"/>
            <result column="f_type" property="type"/>
        </association>
        <association property="secondRequestFile" javaType="org.complitex.osznconnection.file.entity.RequestFile">
            <id column="s_id" property="id"/>
            <result column="s_groupId" property="groupId"/>
            <result column="s_loaded" property="loaded"/>
            <result column="s_name" property="name"/>
            <result column="s_directory" property="directory"/>
            <result column="s_organization_id" property="organizationId"/>
            <result column="s_user_organization_id" property="userOrganizationId"/>
            <result column="s_begin_date" property="beginDate"/>
            <result column="s_end_date" property="endDate"/>
            <result column="s_dbf_record_count" property="dbfRecordCount"/>
            <result column="s_length" property="length"/>
            <result column="s_check_sum" property="checkSum"/>
            <result column="s_type" property="type"/>
        </association>
    </resultMap>

    <sql id="permissionFilter">
        <!--<if test="not admin">
            AND ((f.`user_organization_id` IS NULL OR f.`user_organization_id` IN ${userOrganizationsString})
            AND (s.`user_organization_id` IS NULL OR s.`user_organization_id` IN ${userOrganizationsString}))
            <if test="outerOrganizationsString != null">
                AND (f.`organization_id` IN ${outerOrganizationsString})
            </if>
        </if>-->
    </sql>

    <sql id="requestFileGroupFilterWhere">
        <where>            
            <if test="id != null">and g.`id` = #{id}</if>
            <if test="loaded != null">and YEAR(f.`loaded`) = YEAR(#{loaded}) and DAYOFYEAR(f.`loaded`) = DAYOFYEAR(#{loaded})</if>
            <if test="name != null">and f.`name` like CONCAT('%',#{name},'%')</if>            
            <if test="organizationId != null">and f.`organization_id` = #{organizationId}</if>
            <if test="userOrganizationId != null">and f.`user_organization_id` = #{userOrganizationId}</if>
            <if test="year != null">and YEAR(f.`begin_date`) = #{year}</if>
            <if test="month != null">and MONTH(f.`begin_date`) = #{month}</if>
            <if test="status != null">and (f.`status` = #{status} or s.`status` = #{status})</if>
            <if test="edrpou != null">
                and f.`name` like concat('%', #{edrpou}, '%')
            </if>

            <include refid="permissionFilter"/>
        </where>
    </sql>

    <select id="selectPrivilegeFilesGroups" parameterType="org.complitex.osznconnection.file.entity.RequestFileFilter" 
            resultMap="privilegeFileGroupResultMap">
        select
        f.group_id as gid,
        
        f.id as f_id, f.loaded as f_loaded, f.name as f_name, f.directory as f_directory,
        f.organization_id as f_organization_id, f.`user_organization_id` as f_user_organization_id,
        f.begin_date as f_begin_date, f.end_date as f_end_date, f.dbf_record_count as f_dbf_record_count,
        f.length as f_length, f.check_sum as f_check_sum, f.type as f_type,

        s.id as s_id, s.loaded as s_loaded, s.name as s_name, s.directory as s_directory,
        s.organization_id as s_organization_id, s.`user_organization_id` as s_user_organization_id,
        s.begin_date as s_begin_date, s.end_date as s_end_date, s.dbf_record_count as s_dbf_record_count,
        s.length as s_length, s.check_sum as s_check_sum, s.type as s_type,

        (select count(1) from `dwelling_characteristics` where `request_file_id` = f.`id`) as loaded_record_count,
        (select count(1) from `dwelling_characteristics` where `request_file_id` = f.`id` and `account_number` is not null) as binded_record_count,
        (select count(1) from `dwelling_characteristics` where `request_file_id` = f.`id` and `status` = 215) as filled_record_count
        
        from request_file f join request_file s on (f.group_id = s.group_id and f.type = 6 and s.type = 7) 
        
        <include refid="requestFileGroupFilterWhere"/>
        
        <if test="sortProperty != null">
            <choose>
                <when test="sortProperty == 'status'">order by f.`status`</when>
                <when test="sortProperty == 'firstName'">order by f.`name`</when>
                <when test="sortProperty == 'secondName'">order by s.`name`</when>
                <when test="sortProperty == 'service_provider'">order by f.`name`</when>
                <when test="sortProperty == 'month'">order by MONTH(f.`begin_date`)</when>
                <when test="sortProperty == 'year'">order by YEAR(f.`begin_date`)</when>
                <otherwise>order by f.`${sortProperty}`</otherwise>
            </choose>
            <choose>
                <when test="ascending">asc</when>
                <otherwise>desc</otherwise>
            </choose>
        </if>
        
        ${limit}
    </select>
    
    <select id="selectPrivilegeFilesGroupsCount" parameterType="org.complitex.osznconnection.file.entity.RequestFileFilter"
            resultType="long">
        select count(distinct f.`group_id`)
        from request_file f join request_file s on (f.group_id = s.group_id and f.type = 6 and s.type = 7)
        <include refid="requestFileGroupFilterWhere"/>
    </select>



</mapper>