<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.complitex.common.strategy.EntityBean">
    <resultMap id="entityResultMap" type="org.complitex.common.entity.Entity">
        <id column="e_id" property="id"/>
        <result column="entity" property="entity"/>
        <collection property="names" ofType="StringValue" column="e_name_id" select="findNames"/>

        <collection property="attributes" ofType="org.complitex.common.entity.EntityAttribute">
            <id column="ea_id" property="id"/>
            <result column="required" property="required"/>
            <result column="ea_start_date" property="startDate"/>
            <result column="ea_end_date" property="endDate"/>
            <result column="system" property="system"/>
            <result column="value_type_id" property="valueType"/>
            <result column="reference_id" property="referenceId"/>
            <collection property="names" column="ea_name_id" select="findNames"/>
        </collection>
    </resultMap>

    <select id="load" parameterType="map" resultMap="entityResultMap">
        SELECT
        e.`id` e_id,
        e.`entity`,
        e.`name_id` e_name_id,
        ea.`id` ea_id,
        ea.`required`,
        ea.`start_date` ea_start_date,
        ea.`end_date` ea_end_date,
        ea.`name_id` ea_name_id,
        ea.`system`,
        ea.`value_type_id`,
        ea.`reference_id`
        FROM `entity` e
        JOIN `entity_attribute` ea ON ea.`entity_id` = e.`id`
        WHERE e.`entity` = #{entity}
    </select>

    <select id="findNames" parameterType="long"
            resultMap="org.complitex.common.strategy.DomainObjectStrategy.stringValueResultMap">
        SELECT sc.* FROM `entity_string_value` sc WHERE sc.`id` = #{value}
    </select>

    <insert id="insertAttributeType" useGeneratedKeys="true" keyProperty="id"
            parameterType="org.complitex.common.entity.EntityAttribute">
        INSERT INTO `entity_attribute`(`entity_id`, `required`, `name_id`, `start_date`, `value_type_id`, `reference_id`)
          VALUES (#{entityId}, #{required}, #{nameId}, #{startDate}, #{valueTypeId}, #{referenceId})
    </insert>

    <insert id="insertValueType">
        INSERT INTO `entity_attribute_value_type`(`entity_attribute_id`, `value_type`) VALUES (#{entityAttributeId}, #{valueType})
    </insert>

    <select id="allEntities" resultType="string">
        SELECT e.`entity` FROM `entity` e
    </select>

    <update id="removeAttributeTypes" parameterType="map">
        UPDATE `entity_attribute` SET `end_date` = #{endDate} WHERE `id` IN
        <foreach item="id" collection="attributeTypeIds" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </update>

    <select id="selectEntities" parameterType="org.complitex.common.entity.FilterWrapper" resultMap="entityResultMap">
        SELECT
            e.`id` e_id,
            e.`entity`,
            e.`name_id` e_name_id,
            ea.`id` ea_id,
            ea.`required`,
            ea.`start_date` ea_start_date,
            ea.`end_date` ea_end_date,
            ea.`name_id` ea_name_id,
            ea.`system`,
            ea.`value_type_id`,
            ea.`reference_id`
        FROM `entity` e
        JOIN `entity_attribute` ea ON ea.`entity_id` = e.`id`
    </select>

    <select id="selectEntitiesCount" parameterType="org.complitex.common.entity.FilterWrapper" resultType="long">
        select count(id) from `entity`
    </select>
</mapper>